<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spotify Random Picker</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Montserrat', sans-serif; background: #1e1e2f; color: #fff; display: flex; flex-direction: column; align-items: center; padding: 20px; }
h1 { margin-bottom: 20px; }
#tracks { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; max-width: 900px; }
.track-card { width: 160px; padding: 10px; border-radius: 12px; background: linear-gradient(135deg, #ff9a9e, #fad0c4); color: #fff; font-weight: bold; cursor: pointer; text-align: center; transition: transform 0.3s, box-shadow 0.3s; }
.track-card:hover { transform: scale(1.08); box-shadow: 0 0 20px rgba(255,255,255,0.6), 0 8px 25px rgba(0,0,0,0.3); }
.track-card img { width: 120px; height: 120px; border-radius: 8px; display: block; margin: 0 auto 8px; }
button { margin-top: 20px; padding: 10px 20px; border: none; border-radius: 10px; background-color: #4CAF50; color: white; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
button:hover { background-color: #45a049; }
#status { margin-top: 15px; font-weight: bold; }
</style>
</head>
<body>
<h1>Choose a song to add!</h1>
<div id="tracks"></div>
<button id="refreshBtn">Refresh</button>
<p id="status"></p>

<script>
let allTracks = [];
let displayedTracks = [];

async function fetchPlaylistTracks() {
  try {
    const res = await fetch("/api/get-tracks"); // source playlist
    if (!res.ok) throw new Error("Failed to fetch playlist tracks");
    allTracks = await res.json();
    showRandomTracks();
  } catch (err) {
    console.error(err);
    document.getElementById("status").innerText = "❌ Error fetching playlist";
  }
}

function showRandomTracks() {
  if (!allTracks.length) return;
  displayedTracks = [];
  const copy = [...allTracks];
  const count = Math.min(5, copy.length);
  for (let i = 0; i < count; i++) {
    const index = Math.floor(Math.random() * copy.length);
    displayedTracks.push(copy.splice(index, 1)[0]);
  }
  renderTracks();
}

function renderTracks() {
  const container = document.getElementById("tracks");
  container.innerHTML = "";
  displayedTracks.forEach(track => {
    const div = document.createElement("div");
    div.className = "track-card";
    div.innerHTML = `<img src="${track.image}" alt="${track.name}"><strong>${track.name}</strong><br><span style="font-size:0.85em">${track.artist}</span>`;
    div.onclick = () => addSong(track.uri);
    container.appendChild(div);
  });
}

async function addSong(trackUri) {
  const statusEl = document.getElementById("status");
  statusEl.innerText = "Adding...";
  try {
    const res = await fetch("/api/add-song", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ songUri: trackUri })
    });
    const data = await res.json();
    if (data.error) {
      statusEl.innerText = `❌ Error: ${data.error}${data.details ? " — " + data.details : ""}`;
    } else {
      statusEl.innerText = "✅ Song added!";
    }
  } catch (err) {
    console.error(err);
    statusEl.innerText = `❌ Failed to fetch — ${err.message}`;
  }
}

document.getElementById("refreshBtn").onclick = showRandomTracks;

// Initial fetch
fetchPlaylistTracks();
</script>
</body>
</html>
