<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spotify Random Picker</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Montserrat', sans-serif; background: #1e1e2f; color: #fff; display: flex; flex-direction: column; align-items: center; padding: 20px; }
h1 { margin-bottom: 20px; }
#tracks, #searchResults { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; max-width: 900px; }
.track-card { width: 160px; padding: 10px; border-radius: 12px; background: linear-gradient(135deg, #ff9a9e, #fad0c4); color: #fff; font-weight: bold; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s; }
.track-card:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
.track-card img { width: 120px; height: 120px; border-radius: 8px; display: block; margin: 0 auto 8px; }
button { margin-top: 20px; padding: 10px 20px; border: none; border-radius: 10px; background-color: #4CAF50; color: white; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
button:hover { background-color: #45a049; }
#status { margin-top: 15px; font-weight: bold; }
#searchSection { margin-top: 30px; display: flex; gap: 10px; }
#searchInput { padding: 5px 10px; border-radius: 5px; border: none; width: 300px; }
#searchBtn { padding: 5px 15px; border-radius: 5px; border: none; background-color: #2196F3; color: white; font-weight: bold; cursor: pointer; }
#searchBtn:hover { background-color: #1976D2; }
</style>
</head>
<body>
<h1>Choose a song to add!</h1>
<div id="tracks"></div>
<button id="refreshBtn">Refresh</button>
<p id="status"></p>

<div id="searchSection">
  <input type="text" id="searchInput" placeholder="Search Spotify for a song">
  <button id="searchBtn">Search</button>
</div>
<div id="searchResults"></div>

<script>
let allTracks = [];
let currentTracks = [];
let usedTrackUris = new Set(); // Track used URIs to prevent repeats

async function fetchPlaylistTracks() {
  const statusEl = document.getElementById("status");
  statusEl.innerText = "Loading playlist...";
  try {
    const res = await fetch("/api/get-tracks");
    if (!res.ok) throw new Error("Failed to fetch playlist tracks");
    allTracks = await res.json();
    usedTrackUris.clear(); // reset used set on refresh
    getRandomTracks();
    statusEl.innerText = "";
  } catch (err) {
    console.error(err);
    statusEl.innerText = "âŒ Error fetching playlist";
  }
}

function getRandomTracks() {
  if (!allTracks.length) return;
  currentTracks = [];
  const available = allTracks.filter(t => !usedTrackUris.has(t.uri));
  if (!available.length) {
    document.getElementById("status").innerText = "All songs used, refreshing playlist...";
    usedTrackUris.clear();
    getRandomTracks();
    return;
  }
  for (let i = 0; i < 5 && available.length; i++) {
    const index = Math.floor(Math.random() * available.length);
    const track = available.splice(index,1)[0];
    currentTracks.push(track);
    usedTrackUris.add(track.uri);
  }
  renderTracks();
}

function renderTracks() {
  const container = document.getElementById("tracks");
  container.innerHTML = "";
  currentTracks.forEach(track => {
    const div = document.createElement("div");
    div.className = "track-card";
    div.innerHTML = `<img src="${track.image}" alt="${track.name}"><strong>${track.name}</strong><br><span style="font-size:0.85em">${track.artist}</span>`;
    div.onclick = () => addSong(track.uri);
    container.appendChild(div);
  });
}

async function addSong(trackUri) {
  const statusEl = document.getElementById("status");
  statusEl.innerText = "Adding...";
  try {
    const res = await fetch("/api/add-song", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ songUri: trackUri })
    });
    const data = await res.json();
    if (data.error) {
      statusEl.innerText = `âŒ Error: ${data.error}${data.details ? " â€” " + data.details : ""}`;
    } else {
      statusEl.innerText = "âœ… Song added!";
    }
  } catch (err) {
    console.error(err);
    statusEl.innerText = `âŒ Failed to fetch â€” ${err.message}`;
  }
}

// Refresh button
document.getElementById("refreshBtn").onclick = fetchPlaylistTracks;

// Spotify Search
document.getElementById("searchBtn").onclick = async () => {
  const query = document.getElementById("searchInput").value.trim();
  const resultsEl = document.getElementById("searchResults");
  if (!query) return;
  resultsEl.innerHTML = "Searching...";
  try {
    const res = await fetch(`/api/search-song?query=${encodeURIComponent(query)}`);
    if (!res.ok) throw new Error("Search failed");
    const tracks = await res.json();
    resultsEl.innerHTML = "";
    const addedUris = new Set(); // avoid duplicates in search results
    tracks.forEach(track => {
      if (addedUris.has(track.uri)) return;
      addedUris.add(track.uri);
      const div = document.createElement("div");
      div.className = "track-card";
      div.innerHTML = `<img src="${track.image}" alt="${track.name}"><strong>${track.name}</strong><br><span style="font-size:0.85em">${track.artist}</span>`;
      div.onclick = () => addSong(track.uri);
      resultsEl.appendChild(div);
    });
    if (!tracks.length) resultsEl.innerHTML = "No results found";
  } catch (err) {
    console.error(err);
    resultsEl.innerHTML = "ya rabi ðŸ˜”";
  }
};

// Initial fetch
fetchPlaylistTracks();
</script>
</body>
</html>
