<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spotify Random Picker</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Montserrat', sans-serif;
  background: #1e1e2f;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}
h1 {
  margin-bottom: 20px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: #00ffe1;
  text-shadow: 0 0 10px #00ffe1;
}
#tracks {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
  max-width: 900px;
}
.track-card {
  width: 160px;
  padding: 10px;
  border-radius: 12px;
  background: linear-gradient(135deg, #ff9a9e, #fad0c4);
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  text-align: center;
  transition: transform 0.3s, box-shadow 0.3s, filter 0.3s;
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.5s forwards;
}
.track-card:hover {
  transform: scale(1.08);
  box-shadow: 0 8px 25px rgba(0,255,255,0.5);
  filter: brightness(1.2);
}
.track-card img {
  width: 120px;
  height: 120px;
  border-radius: 12px;
  display: block;
  margin: 0 auto 8px;
}
button {
  margin-top: 20px;
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  background-color: #00ffe1;
  color: #1e1e2f;
  font-weight: bold;
  cursor: pointer;
  font-size: 1rem;
  transition: background-color 0.3s, transform 0.2s;
}
button:hover {
  background-color: #00b8a9;
  transform: scale(1.05);
}
#status {
  margin-top: 15px;
  font-weight: bold;
  font-size: 1.1rem;
  color: #ff6b6b;
  transition: all 0.3s;
}

/* shimmer animation for loading */
.shimmer {
  background: linear-gradient(90deg, #444 25%, #555 50%, #444 75%);
  background-size: 200% 100%;
  animation: shimmer 1.2s infinite;
  height: 120px;
  width: 120px;
  margin: 0 auto 8px;
  border-radius: 12px;
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
</head>
<body>
<h1>Choose a song to add!</h1>
<div id="tracks"></div>
<button id="refreshBtn">Refresh</button>
<p id="status"></p>

<script>
let allTracks = [];
let currentTracks = [];

async function fetchPlaylistTracks() {
  const container = document.getElementById("tracks");
  container.innerHTML = "";  
  // show shimmer placeholders while loading
  for (let i=0; i<5; i++) {
    const div = document.createElement("div");
    div.className = "track-card";
    div.innerHTML = `<div class="shimmer"></div>`;
    container.appendChild(div);
  }

  try {
    const res = await fetch("/api/get-tracks");
    if (!res.ok) throw new Error("Failed to fetch playlist tracks");
    allTracks = await res.json();
    getRandomTracks();
  } catch (err) {
    console.error(err);
    document.getElementById("status").innerText = "❌ Error fetching playlist";
  }
}

function getRandomTracks() {
  if (!allTracks.length) return;
  currentTracks = [];
  const copy = [...allTracks];
  for (let i = 0; i < 5; i++) {
    const index = Math.floor(Math.random() * copy.length);
    currentTracks.push(copy.splice(index,1)[0]);
  }
  renderTracks();
}

function renderTracks() {
  const container = document.getElementById("tracks");
  container.innerHTML = "";
  currentTracks.forEach((track, i) => {
    const div = document.createElement("div");
    div.className = "track-card";
    div.style.animationDelay = `${i*0.1}s`; // stagger animation
    div.innerHTML = `<img src="${track.image}" alt="${track.name}"><strong>${track.name}</strong><br><span style="font-size:0.85em">${track.artist}</span>`;
    div.onclick = () => addSong(track.uri);
    container.appendChild(div);
  });
}

async function addSong(trackUri) {
  const statusEl = document.getElementById("status");
  statusEl.innerText = "Adding...";
  statusEl.style.color = "#00ffe1";
  try {
    const res = await fetch("/api/add-song", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ songUri: trackUri })
    });

    const data = await res.json();

    if (data.error) {
      statusEl.innerText = `❌ Error: ${data.error}${data.details ? " — " + data.details : ""}`;
      statusEl.style.color = "#ff6b6b";
    } else {
      statusEl.innerText = "✅ Song added!";
      statusEl.style.color = "#00ff99";
    }
  } catch (err) {
    console.error(err);
    statusEl.innerText = `❌ Failed to fetch — ${err.message}`;
    statusEl.style.color = "#ff6b6b";
  }
}

document.getElementById("refreshBtn").onclick = getRandomTracks;

// Initial fetch
fetchPlaylistTracks();
</script>
</body>
</html>
