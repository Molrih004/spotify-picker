<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spotify Random Picker</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Montserrat', sans-serif; background: #1e1e2f; color: #fff; display: flex; flex-direction: column; align-items: center; padding: 20px; }
h1 { margin-bottom: 20px; }
#tracks, #playlistContainer { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; max-width: 900px; margin-top: 15px; }
.track-card { width: 160px; padding: 10px; border-radius: 12px; background: linear-gradient(135deg, #ff9a9e, #fad0c4); color: #fff; font-weight: bold; cursor: pointer; text-align: center; transition: transform 0.3s, box-shadow 0.3s, background 0.3s; opacity: 0; transform: translateY(20px); }
.track-card.show { opacity: 1; transform: translateY(0); }
.track-card:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
.track-card img { width: 120px; height: 120px; border-radius: 8px; display: block; margin: 0 auto 8px; }
button { margin-top: 20px; padding: 10px 20px; border: none; border-radius: 10px; background-color: #4CAF50; color: white; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
button:hover { background-color: #45a049; }
#status { margin-top: 15px; font-weight: bold; }
</style>
</head>
<body>
<h1>Choose a song to add!</h1>
<div id="tracks"></div>
<button id="refreshBtn">Refresh</button>
<button id="showPlaylistBtn">Show My Playlist</button>
<p id="status"></p>
<div id="playlistContainer"></div>

<script>
let allTracks = [];
let currentTracks = [];
let usedTrackUris = new Set();

async function fetchPlaylistTracks() {
  const statusEl = document.getElementById("status");
  statusEl.innerText = "Loading playlist...";
  try {
    const res = await fetch("/api/get-tracks");
    if (!res.ok) throw new Error("Failed to fetch playlist tracks");
    allTracks = await res.json();
    usedTrackUris.clear();
    getRandomTracks();
    statusEl.innerText = "";
  } catch (err) {
    console.error(err);
    statusEl.innerText = "❌ Error fetching playlist";
  }
}

function getRandomTracks() {
  if (!allTracks.length) return;
  currentTracks = [];
  const available = allTracks.filter(t => !usedTrackUris.has(t.uri));
  if (!available.length) {
    usedTrackUris.clear();
    getRandomTracks();
    return;
  }
  for (let i = 0; i < 5 && available.length; i++) {
    const index = Math.floor(Math.random() * available.length);
    const track = available.splice(index,1)[0];
    currentTracks.push(track);
    usedTrackUris.add(track.uri);
  }
  renderTracks();
}

function renderTracks() {
  const container = document.getElementById("tracks");
  container.innerHTML = "";
  currentTracks.forEach((track, i) => {
    const div = document.createElement("div");
    div.className = "track-card";
    div.innerHTML = `<img src="${track.image}" alt="${track.name}"><strong>${track.name}</strong><br><span style="font-size:0.85em">${track.artist}</span>`;
    div.onclick = () => addSong(track.uri);
    container.appendChild(div);
    setTimeout(() => div.classList.add("show"), i*100);
  });
}

async function addSong(trackUri) {
  const statusEl = document.getElementById("status");
  statusEl.innerText = "Adding...";
  try {
    const res = await fetch("/api/add-song", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ songUri: trackUri })
    });
    const data = await res.json();
    if (data.error) {
      statusEl.innerText = `❌ Error: ${data.error}${data.details ? " — " + data.details : ""}`;
    } else {
      statusEl.innerText = "✅ Song added!";
    }
  } catch (err) {
    console.error(err);
    statusEl.innerText = `❌ Failed to fetch — ${err.message}`;
  }
}

// Show playlist
document.getElementById("showPlaylistBtn").onclick = async () => {
  const container = document.getElementById("playlistContainer");
  const statusEl = document.getElementById("status");
  statusEl.innerText = "Loading playlist...";
  try {
    const res = await fetch("/api/get-my-playlist");
    if (!res.ok) throw new Error("Failed to fetch playlist");
    const tracks = await res.json();
    container.innerHTML = "";
    tracks.forEach((track, i) => {
      const div = document.createElement("div");
      div.className = "track-card";
      div.innerHTML = `<img src="${track.image}" alt="${track.name}"><strong>${track.name}</strong><br><span style="font-size:0.85em">${track.artist}</span><br><button onclick="deleteSong('${track.uri}')">Delete</button>`;
      container.appendChild(div);
      setTimeout(() => div.classList.add("show"), i*100);
    });
    statusEl.innerText = "";
  } catch (err) {
    console.error(err);
    statusEl.innerText = "❌ Failed to load playlist";
  }
};

// Delete song
async function deleteSong(uri) {
  const statusEl = document.getElementById("status");
  statusEl.innerText = "Deleting...";
  try {
    const res = await fetch("/api/delete-song", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ songUri: uri })
    });
    const data = await res.json();
    if (data.error) {
      statusEl.innerText = `❌ Error: ${data.error}`;
    } else {
      statusEl.innerText = "✅ Deleted!";
      document.getElementById("showPlaylistBtn").click(); // refresh playlist view
    }
  } catch (err) {
    console.error(err);
    statusEl.innerText = `❌ Failed to delete — ${err.message}`;
  }
}

document.getElementById("refreshBtn").onclick = fetchPlaylistTracks;

// Initial fetch
fetchPlaylistTracks();
</script>
</body>
</html>
